bacula-server 5.0.2-2.2+squeeze1 (admin)
========================================

[Bacula][acasă] — un serviciu pentru copierea (eng. „backup”) și restaurarea datelor.

[acasă]: http://bacula.org/


Instalare pachete
-----------------

Cerință pre-instalare: `postgresql`

    HOSTu:~# apt install bacula-director-pgsql bacula-sd
    The following extra packages will be installed:
      bacula-common bacula-common-pgsql bacula-director-common
      dbconfig-common mt-st mtx

    Configure database for bacula-director-pgsql with dbconfig-common?  Yes
    PostgreSQL application password for bacula-director-pgsql:	        [blank]

Notă: **apt** este un alias pentru `apt-get --purge` dar poți utiliza `aptitude` la fel de bine.

### Fixează rotația jurnalului

Pentru [rotirea automată][694046] a jurnalului editează fișierul `/etc/logrotate.d/bacula-common` să conțină:

    /var/log/bacula/log {
      create  0640 bacula adm
      compress
      delaycompress
      missingok
      notifempty
      rotate 12
      monthly
    }

[694046]: http://bugs.debian.org/694046


Configurare serviciu
--------------------

### Bacula Storage Daemon

Editează fișierul principal de configurare `/etc/bacula/bacula-sd.conf` să conțină:

    #
    # Default Bacula Storage Daemon Configuration file
    #

    Storage {
      Name = <BACULAMASTER>-sd
      SDPort = 9103
      WorkingDirectory = "/var/lib/bacula"
      Pid Directory = "/var/run/bacula"
      Maximum Concurrent Jobs = 20
      #SDAddress = 127.0.0.1
    }

    # List Directors who are permitted to contact Storage Daemon
    Director {
      Name = <BACULAMASTER>-dir
      Password = "************"
    }

    # Restricted Director, used by tray-monitor to get the
    #   status of the storage daemon
    Director {
      Name = bacula-tray-monitor
      Password = "*************"
      Monitor = yes
    }

    # Send all messages to the Director,
    # mount messages also are sent to the email address
    Messages {
      Name = Standard
      Director = <BACULAMASTER>-dir = all
    }

    # config automatically generated by 'update-bacula'
    @/var/cache/bacula/storage.conf

Implicit `<BACULAMASTER>` este numele scurt al hostului pe care este instalat serviciul.

### Bacula Director

Editează fișierul principal de configurare `/etc/bacula/bacula-dir.conf` să conțină:

    #
    # Default Bacula Director Configuration file
    #

    Director {
      Name = <BACULAMASTER>-dir
      DIRport = 9101
      QueryFile = "/etc/bacula/scripts/query.sql"
      WorkingDirectory = "/var/lib/bacula"
      PidDirectory = "/var/run/bacula"
      Maximum Concurrent Jobs = 20
      Password = "***************"
      Messages = Daemon
      #DirAddress = 127.0.0.1
    }

    # Generic catalog service
    Catalog {
      Name = MyCatalog
      dbname = bacula; DB Address = ""; dbuser = "bacula"; dbpassword = "******"
    }

    # Restricted console used by tray-monitor to get the status of the director
    Console {
      Name = bacula-tray-monitor
      Password = "*************"
      CatalogACL = MyCatalog
      CommandACL = status, .status
    }

    @/etc/bacula/director/messsages.conf
    @/etc/bacula/director/schedules.conf

    # config automatically generated by 'update-bacula'
    @/var/cache/bacula/director.conf

Implicit `<BACULAMASTER>` este numele scurt al hostului pe care este instalat serviciul.

Crează fișierul de configurare `/etc/bacula/director/messsages.conf` să conțină:

    #
    # Bacula Director -- messages
    #

    # Reasonable message delivery -- send most everything to email address
    #  and to the console
    Messages {
      Name = Standard
      mailcommand = "/usr/sbin/bsmtp -h SMTPHOST -f \"Bacula \<bacula@HOST.DOMAIN.tld\>\" -s \"Bacula job #%i: %l %t for '%n' finished with status %e\" %r"
      mail on error = bacula+jobs@DOMAIN.tld = all, !skipped

      operatorcommand = "/usr/sbin/bsmtp -h SMTPHOST -f \"Bacula \<bacula@HOST.DOMAIN.tld\>\" -s \"Bacula job #%i: intervention needed for %j\" %r"
      operator = bacula+operator@DOMAIN.tld = mount

      append = "/var/log/bacula/log" = all, !skipped
      catalog = all, !skipped
      console = warning
    }

    # Message delivery for daemon messages
    Messages {
      Name = Daemon
      mailcommand = "/usr/sbin/bsmtp -h SMTPHOST -f \"Bacula \<bacula@HOST.DOMAIN.tld\>\" -s \"Bacula daemon message\" %r"
      mail = bacula+daemon@DOMAIN.tld = all, !skipped
      append = "/var/log/bacula/log" = all, !skipped
      console = all, !skipped
    }

Notă: de înlocuit *SMTPHOST*, *DOMAIN.tld* și *BACULAMASTER*.

Semnificația parametrilor configurați pentru mesaje este descrisă în pagina [*Messages Resource*][bmsg].

[bmsg]: http://www.bacula.org/en/dev-manual/main/main/Messages_Resource.html

Crează fișierul de configurare `/etc/bacula/director/schedules.conf` să conțină:

    #
    # Bacula Director -- schedules
    #

    Schedule {
      Name = "daily"
      Run = Full on Tue-Sat at 02:00
    }

    Schedule {
      Name = "weekly"
      Run = Full on Sun at 01:20
    }

    Schedule {
      Name = "monthly"
      Run = Full on 1 at 01:40
      Run = Differential on 2nd-5th Sat at 01:40
      Run = Incremental on 2-31 Sun-Fri at 01:40
    }


Configurare «update-bacula»
---------------------------

Crează fișierul `/etc/bacula/backups.list` să conțină ceva asemănător cu:

    #CLIENT | PASSWORD | SCHEDULE | STORAGE | FILE/JOB/VOL RETENTION | MAX VOL JOBS | VOL USE DURATION | AUTOPRUNE | JOBS
    #--------------------------------------------------------------------------------------------------------------------
    host1   | ******** | daily    | master1 | 6 months, 6 months, 2 months | 1 |         | yes | cvsrepo1 cvsrepo2 | toate repozitoriile CVS
    host2   | ******** | monthly  | master2 | 6 months, 6 months, 2 months |   | 1 month | yes | maildir-user1 maildir-user2 | toate conturile email

Atenție: perioda de retenție *File/Job* trebuie să fie mai mare decât perioada de
reteție *Volume*, altfel nu vei putea restaura din volume vechi presente pe disk
(deoarece înregistrările necesare *File* și *Job* au fost șterse din baza de date)

Crează fișierul `/etc/default/update-bacula` să conțină:

    STORAGEPW="********************"

Parola se obține din configurația serviciului *Bacula Storage Daemon*.

Execută următoarele comenzi pentru a prelua ultimele modificări:

    update-bacula
    service bacula-sd restart
    service bacula-director restart
